<!DOCTYPE html>
<html>
<head>
    <style>
        * { margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>
    <video id="video" autoplay muted playsinline></video>
    <script>
        const params = new URLSearchParams(location.search);
        const stream = params.get('src');
        const video = document.getElementById('video');

        let pc = null;
        let retryCount = 0;

        async function connect() {
            if (pc) {
                pc.close();
                pc = null;
            }

            try {
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                pc.ontrack = (event) => {
                    video.srcObject = event.streams[0];
                    video.play().catch(() => {});
                    retryCount = 0;
                };

                pc.oniceconnectionstatechange = () => {
                    if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
                        setTimeout(connect, 2000);
                    }
                };

                pc.addTransceiver('video', { direction: 'recvonly' });
                pc.addTransceiver('audio', { direction: 'recvonly' });

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                // Wait for ICE candidates
                await new Promise(resolve => {
                    if (pc.iceGatheringState === 'complete') resolve();
                    else pc.onicegatheringstatechange = () => {
                        if (pc.iceGatheringState === 'complete') resolve();
                    };
                    setTimeout(resolve, 2000);
                });

                // Send to RTSPtoWebRTC
                const response = await fetch(`http://${location.hostname}:8083/stream/${stream}/channel/0/webrtc?uuid=${stream}&channel=0`, {
                    method: 'POST',
                    body: new URLSearchParams({ data: btoa(pc.localDescription.sdp) })
                });

                if (!response.ok) throw new Error('WebRTC failed');

                const answer = await response.text();
                await pc.setRemoteDescription({
                    type: 'answer',
                    sdp: atob(answer)
                });

                console.log('WebRTC connected');

            } catch (err) {
                console.error('Error:', err);
                retryCount++;
                setTimeout(connect, Math.min(2000 * retryCount, 10000));
            }
        }

        connect();
    </script>
</body>
</html>
