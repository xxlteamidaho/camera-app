<!DOCTYPE html>
<html>
<head>
    <style>
        * { margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>
    <video id="video" autoplay muted playsinline></video>
    <script>
        const params = new URLSearchParams(location.search);
        const src = params.get('src');
        const video = document.getElementById('video');

        let pc = null;
        let reconnectDelay = 1000;

        async function connect() {
            // Cleanup previous connection
            if (pc) {
                pc.close();
                pc = null;
            }

            try {
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                pc.ontrack = (event) => {
                    video.srcObject = event.streams[0];
                    video.play().catch(() => {});
                };

                pc.oniceconnectionstatechange = () => {
                    if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
                        console.log('ICE connection failed, reconnecting...');
                        setTimeout(connect, reconnectDelay);
                    }
                };

                // Create offer
                pc.addTransceiver('video', { direction: 'recvonly' });
                pc.addTransceiver('audio', { direction: 'recvonly' });

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                // Wait for ICE gathering
                await new Promise((resolve) => {
                    if (pc.iceGatheringState === 'complete') {
                        resolve();
                    } else {
                        pc.onicegatheringstatechange = () => {
                            if (pc.iceGatheringState === 'complete') resolve();
                        };
                        // Timeout after 3s
                        setTimeout(resolve, 3000);
                    }
                });

                // Send offer to go2rtc
                const response = await fetch(`http://${location.hostname}:1984/api/webrtc?src=${src}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/sdp' },
                    body: pc.localDescription.sdp
                });

                if (!response.ok) throw new Error('WebRTC setup failed');

                const answer = await response.text();
                await pc.setRemoteDescription({ type: 'answer', sdp: answer });

                reconnectDelay = 1000;
                console.log('WebRTC connected');

            } catch (err) {
                console.error('WebRTC error:', err);
                reconnectDelay = Math.min(reconnectDelay * 1.5, 30000);
                setTimeout(connect, reconnectDelay);
            }
        }

        connect();
    </script>
</body>
</html>
